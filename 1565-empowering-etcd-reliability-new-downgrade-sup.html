<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<!-- Prevent, to some degree, the execution of inline JavaScript, as well as blocking all plugin content  -->
		<meta http-equiv="Content-Security-Policy" content="script-src 'none'; object-src 'none'; img-src 'none'; font-src 'none'; media-src 'none'; worker-src 'none'; connect-src 'none'; style-src 'self' ">
		<title>Empowering etcd Reliability: New Downgrade Support in Version 3.6</title>
		<link rel="icon" href="favicon.png" />
		<link rel="stylesheet" href="/a11y-dark.css">
		<link rel="stylesheet" href="/style.css">
	</head>
	<body>
		<main>
		<a target="_blank" rel="noreferrer" href="http://opensource.googleblog.com/2024/09/empowering-etcd-reliability-new-downgrade-support.html">Go to article URL</a>
		<div id="content"><p></p><meta content="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiGkMcQkTcMxeWdrytLd_PeruB1foXQWiUfH7j10rXpIbtzXcCLXeca5wXlR9ueHIJnIAg7p3F3afB7kYslg-BYW4TxGx-BJssH2Ady1xPtZzl8CL5xzAjwEXyE8WR1WdTJbZi1lotF-1AscOc24UGDL9LXCu_6A_nlFZ2O59MhvTdtIdvJeaQ2-GmlYYU/s1600/Social%20-%20OSS%20-%20Kubernetes%20Gateway%20API%20graduates%20to%20GA.png" name="twitter:image">


<a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg5Ew4zwACrflispkhfyO2RPltMX4eBYd9sSXXT5hNZ6G2FugX5WAu3wE3fpuJya824APcC0qjVwLxzwxqg2hK957Z4bln1aCl6_Pwwht9BQW6HF-cqjgdQZzRRvhV2qlar_m_t37Pkl5O4BptwMY1D2CX-g_U_x5XhXvrCiaU93gX0GwRTtyCEanRAQTU/s1600/Header%20-%20OSS%20-%20Kubernetes%20Gateway%20API%20graduates%20to%20GA%20%281%29.png" rel="noreferrer" target="_blank"></a>

<div><br></div>

<p>In the world of distributed systems, reliability is paramount. etcd, a widely used key-value store often critical to infrastructure, has made strides in enhancing this aspect. While etcd's reliability has been robust thanks to the Raft consensus protocol, the same couldn't be said for upgrades/downgrades – until now.</p><br>

<h2><b>The Challenge of etcd Downgrades</b></h2>

<p>Historically, downgrading etcd has been a complex and unsupported process. There is no way to safely downgrade etcd data after it was touched by a newer version. Upgrades, while reliable, weren't easily reversible, often requiring external tools and backups. This lack of flexibility posed a significant challenge for users who encountered issues after upgrading.</p><br>

<h2><b>Enter etcd 3.6: A New Era of Downgrade Support</b></h2>

<p>etcd 3.6 introduces a groundbreaking solution: <a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-etcd/4326-downgrade" target="_blank" rel="noreferrer">built-in downgrade support</a>. This innovation not only simplifies the upgrade and downgrade processes but also significantly enhances etcd's reliability.</p>

<h3><b>How Does It Work?</b></h3>

<ul>
<li><b>Storage Versioning:</b> A new storage version (SV) is persisted within the etcd data file. This version indicates compatibility, ensuring safe upgrades and downgrades.</li></ul><ul>
<li><b>Schema Evolution:</b> A comprehensive schema tracks all fields in the data file and acts as a source of truth about which version a particular was introduced in, allowing etcd to understand and manipulate data across versions.</li></ul><ul>
<li><b>etcdutl migrate:</b> A dedicated command-line tool, <span stlye="color:#0d904f;font-family:Courier">etcdutl migrate</span>, streamlines skip-level upgrade and downgrade process, eliminating the need for complex manual steps.</li></ul><h3><b>Benefits for Users</b></h3>

<p>The introduction of downgrade support in etcd 3.6 offers a range of benefits for users:</p>
<ul>
<li><b>Improved Reliability:</b> Upgrades can be safely reverted, reducing the risk of data loss or operational disruption.</li></ul><ul>
<li><b>Simplified Management:</b> The upgrade and downgrade processes are streamlined, reducing the complexity of managing etcd clusters.</li></ul><ul>
<li><b>Increased Flexibility:</b> Users have greater flexibility in managing their etcd environments, allowing them to experiment with new versions and roll back if necessary.</li></ul><h3><b>Under the Hood: Technical Details</b></h3>

<p>To achieve downgrade support, etcd 3.6 implements a strict storage versioning policy. This means that etcd data is versioned, etcd will no longer be allowed to load data generated by version higher than its own, and must rely on cluster downgrade process instead. This ensures that all the DB and WAL files would not have any information that could be incorrectly interpreted.</p> 

<p>During the downgrade process, new fields from the higher version in DB files will be cleaned up. The etcd protocol version will be lowered to allow older versions to join. All new features, rpcs and fields would not be used thus preventing older members from interpreting replicated logs differently. This also means that entries added to the Wal log file should be compatible with lower versions. When a wal snapshot happens, all older incompatible entries should be applied, so they no longer need to be read and the storage version can be downgraded.</p>

<p>The <span stlye="color:#0d904f;font-family:Courier">etcdutl migrate</span> command tool is added to simplify etcd data upgrade and downgrade process on 2+ minor version upgrades/downgrades scenarios, by validating the WAL log compatibility with the target version, and executing any necessary schema changes to the DB file and updating the storage version.</p>

<h3><b>Implementation Milestones</b></h3>

<p>The rollout of downgrade support is planned in three milestones:</p>
<ul>
<li><b>Snapshot Storage Versions:</b> Storage versioning is implemented for snapshots.</li></ul><ul>
<li><b>Version Annotations:</b> etcd code is annotated with versions, and a schema is created for the data file.</li></ul><ul>
<li><b>Full Downgrade Support:</b> Downgrades can be fully implemented using the established storage versioning and schema.</li>
</ul>
<p>We are currently working on finishing the third milestone.</p><br>


<h2><b>Looking Ahead</b></h2>

<p>etcd 3.6 marks a significant step forward in the reliability and manageability of etcd clusters. The introduction of downgrade support empowers users with greater flexibility and control over their etcd environments. As etcd continues to evolve, we can expect further enhancements to the upgrade and downgrade processes, further solidifying its position as a critical component in modern distributed systems.</p>

<p><em>By Siyuan Zhang – Software Engineer</em></p>
<p></p></div>
		<div class="content-meta">
			<time datetime=2024-09-12T09:00:00.000Z>12 September 2024</time>
			<a href="/urls/feeds-feedburner-com-googleopensourceblog">feeds.feedburner.com/GoogleOpenSourceBlog</a>
			<div> <a href="/tags/open-source.html">open-source</a> |  <a style="font-weight: bold" href="/tags/source.html">source</a></div>
		</div>
	</main>
		<footer>
			<nav>
				<a href="/">Home</a>
				<a href="/tags">Tags</a>
				<a href="/urls">URLs</a>
				<a rel="noreferrer" target="_blank" href="https://github.com/thoughtsunificator/rss-feed-static-generator">Source code</a>
			</nav>
		</footer>
		<script src="/highlight.min.js"></script>
		<script>hljs.highlightAll();</script>
		</body>
</html>