<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<!-- Prevent, to some degree, the execution of inline JavaScript, as well as blocking all plugin content  -->
		<meta http-equiv="Content-Security-Policy" content="script-src 'none'; object-src 'none'; img-src 'none'; font-src 'none'; media-src 'none'; worker-src 'none'; connect-src 'none'; style-src 'self' ">
		<title>Docker and iptables</title>
		<link rel="icon" href="favicon.png" />
		<link rel="stylesheet" href="/a11y-dark.css">
		<link rel="stylesheet" href="/style.css">
	</head>
	<body>
		<main>
		<a target="_blank" rel="noreferrer" href="https://www.endpointdev.com/blog/2024/06/docker-and-iptables/">Go to article URL</a>
		<div id="content"><p></p>
        <p></p>
<p>Photo by <a href="https://www.pexels.com/@ekamelev/" rel="noreferrer" target="_blank">Egor Kamelev</a> from <a href="https://www.pexels.com/photo/four-metal-poles-with-link-chains-754113/" rel="noreferrer" target="_blank">Pexels</a>.</p>
<p>Docker utilizes iptables for its networking and routing. Blocking and accepting connections to the running containers on a host might be tricky at first if we are not aware of where Docker puts its chains. Docker chains are all located in the iptables FORWARD chain. Within this chain, Docker provides a convenient chain named DOCKER-USER for users to add their custom rules.</p>
<p>One common mistake is attempting to block Docker Containers at the iptables INPUT chain, which will not work. This is because Docker does not pass through the INPUT chain, it only passes through the FORWARD chain. The following diagram illustrates a simplified chains traversal of Docker containers.</p>
<p></p>
<p>Below are a few working examples of iptables rules that can serve as references. These rules will be applied to the DOCKER-USER chain. It’s important to note that the DOCKER-USER chain comes after the PREROUTING chain and FORWARD chain, so we’ll need to use the iptables conntrack module for getting the information about source addresses and host ports. iptables conntrack extension allows iptables to track the state of network connections passing through the system. This tracking capability enables iptables to make decisions based on the state of connections.</p>
<h3 id="1-blocking-specific-port-and-allowing-access-for-a-specific-ip">1. Blocking Specific Port and Allowing Access for a Specific IP</h3>
<p>The following example allows only the IP address 192.168.0.1 to access port 8080 on this host, while blocking access for all other IPs. We’ll use the network interface eth0.</p>
<div class="highlight"><pre tabindex="0"><code class="language-plain" data-lang="plain"><span><span>iptables -A DOCKER-USER -i eth0 -s 192.168.0.1 -p tcp -m conntrack --ctorigdstport 8080 --ctdir ORIGINAL -j ACCEPT
</span></span><span><span>iptables -I DOCKER-USER -i eth0 -p tcp -m conntrack --ctorigdstport 8080 --ctdir ORIGINAL -j DROP
</span></span></code></pre></div><p><strong>Explanation:</strong></p>
<ul>
<li>The first rule allows incoming TCP traffic (<code>-p tcp</code>) on port 8080 (<code>--ctorigdstport 8080</code>) from the source IP address 192.168.0.1 (<code>-s 192.168.0.1</code>).</li>
<li>The second rule drops all other incoming TCP traffic on port 8080.</li>
</ul>
<h3 id="2-blocking-all-connections-except-for-a-specific-ip">2. Blocking All Connections Except for a Specific IP</h3>
<p>This example blocks all incoming connections to this host but allows access for IP address 192.168.0.1. We’ll again use the network interface eth0.</p>
<div class="highlight"><pre tabindex="0"><code class="language-plain" data-lang="plain"><span><span>iptables -I DOCKER-USER -i ext_if ! -s 192.168.0.1 -j DROP
</span></span></code></pre></div><p><strong>Explanation:</strong></p>
<ul>
<li>This rule drops all incoming traffic (<code>-j DROP</code>) on interface eth0 (<code>-i eth0</code>) except for traffic originating from IP address 192.168.0.1 (<code>! -s 192.168.0.1</code>).</li>
</ul>
<p>The examples above demonstrate how to control access to specific ports and IP addresses using iptables rules. Make sure to adjust the IP addresses, port numbers, and network interfaces according to your specific requirements.</p>
<h3 id="3-to-make-the-rules-permanent">3. To make the rules permanent</h3>
<p>To ensure the added iptables rules are permanent, we need to place them where they can be restored upon boot. On a Red Hat-based Linux system, this location is the <code>/etc/sysconfig/iptables</code> file.</p>
<div class="highlight"><pre tabindex="0"><code class="language-plain" data-lang="plain"><span><span>-N DOCKER-USER
</span></span><span><span>-A DOCKER-USER -i eth0 -p tcp -m conntrack --ctorigdstport 8080 --ctdir ORIGINAL -j DROP
</span></span></code></pre></div><p><strong>Explanation:</strong></p>
<ul>
<li>The first line defines the DOCKER-USER chain (<code>-N DOCKER-USER</code>)</li>
<li>The second line appends the rule to drop all incoming TCP traffic on port 8080</li>
</ul>
<p>Understanding how to configure iptables for Docker containers is crucial for ensuring network security and efficient traffic management. Using these configurations can safeguard Dockerized environments and optimize network performance. Keep exploring and experimenting with iptables to further enhance your Docker deployments.</p>

      <p></p></div>
		<div class="content-meta">
			<time datetime=2024-06-12T00:00:00.000Z>12 June 2024</time>
			<a href="/urls/www-endpointdev-com-blog-feed-xml">www.endpointdev.com/blog/feed.xml</a>
			<div> <a href="/tags/programming.html">programming</a> |  <a href="/tags/reporting.html">reporting</a></div>
		</div>
	</main>
		<footer>
			<nav>
				<a href="/">Home</a>
				<a href="/tags">Tags</a>
				<a href="/urls">URLs</a>
				<a rel="noreferrer" target="_blank" href="https://github.com/thoughtsunificator/rss-feed-static-generator">Source code</a>
			</nav>
		</footer>
		<script src="/highlight.min.js"></script>
		<script>hljs.highlightAll();</script>
		</body>
</html>