<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<!-- Prevent, to some degree, the execution of inline JavaScript, as well as blocking all plugin content  -->
		<meta http-equiv="Content-Security-Policy" content="script-src 'none'; object-src 'none'; img-src 'none'; font-src 'none'; media-src 'none'; worker-src 'none'; connect-src 'none'; style-src 'self' ">
		<title>Introducing the WebAssembly JavaScript Promise Integration API</title>
		<link rel="icon" href="favicon.png" />
		<link rel="stylesheet" href="/a11y-dark.css">
		<link rel="stylesheet" href="/style.css">
	</head>
	<body>
		<main>
		<a target="_blank" rel="noreferrer" href="https://v8.dev/blog/jspi">Go to article URL</a>
		<div id="content"><p></p><p>The JavaScript Promise Integration (JSPI) API allows WebAssembly applications that were written assuming <em>synchronous</em> access to external functionality to operate smoothly in an environment where the functionality is actually <em>asynchronous</em>.</p>
<p>This note outlines what the core capabilities of the JSPI API are, how to access it, how to develop software for it and offers some examples to try out.</p>
<h2 id="what-is-%E2%80%98jspi%E2%80%99-for%3F" tabindex="-1">What is ‘JSPI’ for? <a class="bookmark" href="https://v8.dev/blog/jspi#what-is-%E2%80%98jspi%E2%80%99-for%3F" rel="noreferrer" target="_blank">#</a></h2>
<p>Asynchronous APIs operate by separating the <em>initiation</em> of the operation from its <em>resolution</em>; with the latter coming some time after the first. Most importantly, the application continues execution after kicking off the operation; and is then notified when the operation completes.</p>
<p>For example, using the <code>fetch</code> API, Web applications can access the contents associated with a URL; however, the <code>fetch</code> function does not directly return the results of the fetch; instead it returns a <code>Promise</code> object. The connection between the fetch response and the original request is reestablished by attaching a <em>callback</em> to that <code>Promise</code> object. The callback function can inspect the response and collect the data (if it is there of course).</p>
<p>In many cases C/C++ (and many other languages) applications are originally written against a <em>synchronous</em> API. For example, the Posix <code>read</code> function does not complete until the I/O operation is complete: the <code>read</code> function <em>blocks</em> until the read is complete.</p>
<p>However, it is not permitted to block the browser’s main thread; and many environments are not supportive of synchronous programming. The result is a mismatch between the desires of the application programmer for a simple to use API and the wider ecosystem that requires I/O to be crafted with asynchronous code. This is especially a problem for existing legacy applications that would be expensive to port.</p>
<p>The JSPI is an API that bridges the gap between synchronous applications and asynchronous Web APIs. It works by intercepting <code>Promise</code> objects returned by asynchronous Web API functions and <em>suspending</em> the WebAssembly application. When the asynchronous I/O operation is completed, the WebAssembly application is <em>resumed</em>. This allows the WebAssembly application to use straight-line code to perform asynchronous operations and to process their results.</p>
<p>Crucially, using JSPI requires very few changes to the WebAssembly application itself.</p>
<h3 id="how-does-jspi-work%3F" tabindex="-1">How does JSPI work? <a class="bookmark" href="https://v8.dev/blog/jspi#how-does-jspi-work%3F" rel="noreferrer" target="_blank">#</a></h3>
<p>The JSPI works by intercepting the <code>Promise</code> object returned from  calls to JavaScript and suspending the main logic of the WebAssembly application. A callback is attached to this <code>Promise</code> object which will resume the suspended WebAssembly code when invoked by the browser's event loop task runner.</p>
<p>In addition, the WebAssembly export is refactored to return a <code>Promise</code> object — instead of the original returned value from the export. This <code>Promise</code> object becomes the value returned by the WebAssembly application: when the WebAssembly code is suspended,<sup class="footnote-ref"><a href="https://v8.dev/blog/jspi#fn1" id="fnref1" rel="noreferrer" target="_blank">[1]</a></sup> the export <code>Promise</code> object is returned as the value of the call into WebAssembly.</p>
<p>The export Promise is resolved when the original call completes: if the original WebAssembly function returns a normal value the export <code>Promise</code> object is resolved with that value (converted to a JavaScript object); if an exception is thrown then the export <code>Promise</code> object is rejected.</p>
<h4 id="wrapping-imports-and-exports" tabindex="-1">Wrapping imports and exports <a class="bookmark" href="https://v8.dev/blog/jspi#wrapping-imports-and-exports" rel="noreferrer" target="_blank">#</a></h4>
<p>This is enabled by <em>wrapping</em> imports and exports during the WebAssembly module instantiation phase. The function wrappers add the suspending behavior to the normal asynchronous imports and route suspensions to <code>Promise</code> object callbacks.</p>
<p>It is not necessary to wrap all the exports and imports of a WebAssembly module. Some exports whose execution paths don’t involve calling asynchronous APIs are better left unwrapped. Similarly, not all of a WebAssembly module’s imports are to asynchronous API functions; those imports too should not be wrapped.</p>
<p>Of course, there is a significant amount of internal mechanisms that allow this to happen;<sup class="footnote-ref"><a href="https://v8.dev/blog/jspi#fn2" id="fnref2" rel="noreferrer" target="_blank">[2]</a></sup> but neither the JavaScript language nor WebAssembly itself are changed by the JSPI. Its operations are confined to the boundary between JavaScript and WebAssembly.</p>
<p>From the perspective of a Web application developer, the result is a body of code that participates in the JavaScript world of async functions and Promises in an analogous way that other async functions written in JavaScript work. From the perspective of the WebAssembly developer, this allows them to craft applications using synchronous APIs and yet participate in the Web’s asynchronous ecosystem.</p>
<h3 id="expected-performance" tabindex="-1">Expected performance <a class="bookmark" href="https://v8.dev/blog/jspi#expected-performance" rel="noreferrer" target="_blank">#</a></h3>
<p>Because the mechanisms used when suspending and resuming WebAssembly modules are essentially constant time, we don’t anticipate high costs in using JSPI — especially compared to other transformation based approaches.</p>
<p>There is a constant amount of work needed to propagate the <code>Promise</code> object returned by the asynchronous API call to the WebAssembly. Similarly, when a Promise is resolved, the WebAssembly application can be resumed with constant-time overhead.</p>
<p>However, as with other Promise-style APIs in the browser, any time the WebAssembly application suspends it will not be ‘woken up’ again except by the browser’s task runner. This requires that the execution of the JavaScript code that started the WebAssembly computation itself returns to the browser.</p>
<h3 id="can-i-use-jspi-to-suspend-javascript-programs%3F" tabindex="-1">Can I use JSPI to suspend JavaScript programs? <a class="bookmark" href="https://v8.dev/blog/jspi#can-i-use-jspi-to-suspend-javascript-programs%3F" rel="noreferrer" target="_blank">#</a></h3>
<p>JavaScript already has a well developed mechanism for representing asynchronous computations: the <code>Promise</code> object and the <code>async</code> function notation. The JSPI is designed to integrate well with this but not to replace it.</p>
<h3 id="how-can-i-use-jspi-today%3F" tabindex="-1">How can I use JSPI today? <a class="bookmark" href="https://v8.dev/blog/jspi#how-can-i-use-jspi-today%3F" rel="noreferrer" target="_blank">#</a></h3>
<p>The JSPI is currently being standardized by the W3C WebAssembly WG. As of this writing, it is phase 3 of the standards process and we anticipate full standardization before the end of 2024.</p>
<p>JSPI is available for Chrome on Linux, MacOS, Windows and ChromeOS, on Intel and Arm platforms, both 64 bit and 32 bit.<sup class="footnote-ref"><a href="https://v8.dev/blog/jspi#fn3" id="fnref3" rel="noreferrer" target="_blank">[3]</a></sup></p>
<p>JSPI can be used in two ways today: via an <a href="https://developer.chrome.com/origintrials/#/register_trial/1603844417297317889" rel="noreferrer" target="_blank">origin trial</a> and locally via a Chrome flag. To test it locally, go to <code>chrome://flags</code> in Chrome, search for “Experimental WebAssembly JavaScript Promise Integration (JSPI)” and check the box. Relaunch as suggested for it to take effect.</p>
<p>You should use at least version <code>126.0.6478.26</code> to get the latest version of the API. We recommend using the Dev channel to ensure that any stability updates are applied. In addition, if you wish to use Emscripten to generate WebAssembly (which we recommend), you should use a version that is at least <code>3.1.61</code>.</p>
<p>Once enabled, you should be able to run scripts that use JSPI. Below we show how you can use Emscripten to generate a WebAssembly module in C/C++ that uses JSPI. If your application involves a different language, not using Emscripten for example, then we suggest that you look at how the API works you should look at the <a href="https://github.com/WebAssembly/js-promise-integration/blob/main/proposals/js-promise-integration/Overview.md" rel="noreferrer" target="_blank">proposal</a>.</p>
<h4 id="limitations" tabindex="-1">Limitations <a class="bookmark" href="https://v8.dev/blog/jspi#limitations" rel="noreferrer" target="_blank">#</a></h4>
<p>The Chrome implementation of JSPI already supports typical use cases. However it is still considered to be experimental so there are a few limitations to be aware of:</p>
<ul>
<li>Requires the use of a command line flag, or participation in the origin trial.</li>
<li>Each call to a JSPI export runs on a fixed size stack.</li>
<li>Debugging support is somewhat minimal. In particular, it may be difficult to see the different events happening in the Dev tools panel. Providing a richer support for debugging JSPI applications is on the roadmap.</li>
</ul>
<h2 id="a-small-demo" tabindex="-1">A small demo <a class="bookmark" href="https://v8.dev/blog/jspi#a-small-demo" rel="noreferrer" target="_blank">#</a></h2>
<p>To see all this working, let’s try a simple example. This C program computes Fibonacci in a spectacularly bad way: by asking JavaScript to do the addition, even worse by using JavaScript <code>Promise</code> objects to do it:<sup class="footnote-ref"><a href="https://v8.dev/blog/jspi#fn4" id="fnref4" rel="noreferrer" target="_blank">[4]</a></sup></p>
<pre class="language-c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">promiseFib</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span><br> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><br>   <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><br> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><br>   <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><br> <span class="token keyword">return</span> <span class="token function">promiseAdd</span><span class="token punctuation">(</span><span class="token function">promiseFib</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">promiseFib</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><span class="token comment">// promise an addition</span><br><span class="token function">EM_ASYNC_JS</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">,</span> promiseAdd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">,</span> <span class="token keyword">long</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token operator">+</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>The <code>promiseFib</code> function itself is a straightforward recursive version of the Fibonacci function. The intriguing part (from our point of view) is the definition of <code>promiseAdd</code> which does the addition of the two Fibonacci halves — using JSPI!.</p>
<p>We use the <code>EM_ASYNC_JS</code> Emscripten macro to write down the <code>promiseFib</code> function as a JavaScript function within the body of our C program. Since addition does not normally involve Promises in JavaScript, we have to force it by constructing a <code>Promise</code>.</p>
<p>The <code>EM_ASYNC_JS</code> macro generates all the necessary glue code so that we can use JSPI to access the Promise’s result as though it were a normal function.</p>
<p>To compile our small demo, we use Emscripten’s <code>emcc</code> compiler:<sup class="footnote-ref"><a href="https://v8.dev/blog/jspi#fn5" id="fnref5" rel="noreferrer" target="_blank">[5]</a></sup></p>
<pre class="language-sh"><code class="language-sh">emcc <span class="token parameter variable">-O3</span> badfib.c <span class="token parameter variable">-o</span> b.html <span class="token parameter variable">-s</span> JSPI</code></pre>
<p>This compiles our program, creating a loadable HTML file (<code>b.html</code>). The most special command line option here is <code>-s JSPI</code>. This invokes the option to generate code that uses JSPI to interface with JavaScript imports that return Promises.</p>
<p>If you load the generated <code>b.html</code> file into Chrome, then you should see output that approximates to:</p>
<pre><code>fib(0) 0μs 0μs 0μs
fib(1) 0μs 0μs 0μs
fib(2) 0μs 0μs 3μs
fib(3) 0μs 0μs 4μs
…
fib(15) 0μs 13μs 1225μs
</code></pre>
<p>This is simply a list of the first 15 Fibonacci numbers followed by the average time in microseconds it took to compute a single Fibonacci number. The three time values on each line refer to the time taken for a pure WebAssembly computation, for a mixed JavaScript/WebAssembly computation and the third number gives the time for a suspending version of the computation.</p>
<p>Note that <code>fib(2)</code> is the smallest calculation that involves accessing a Promise, and, by the time <code>fib(15)</code> is computed, approximately 1000 calls to <code>promiseAdd</code> have been made. This suggests that the actual cost of a JSPI’d function is approximately 1μs — significantly higher than just adding two integers but much smaller than the milliseconds typically required for accessing an external I/O function.</p>
<h2 id="using-jspi-to-load-code-lazily" tabindex="-1">Using JSPI to load code lazily <a class="bookmark" href="https://v8.dev/blog/jspi#using-jspi-to-load-code-lazily" rel="noreferrer" target="_blank">#</a></h2>
<p>In this next example we are going to look at what may be a somewhat surprising use of JSPI: dynamically loading code. The idea is to <code>fetch</code> a module that contains needed code, but to delay that until the needed function is first called.</p>
<p>We need to use JSPI because APIs like <code>fetch</code> are inherently asynchronous in nature, but we want to be able to invoke them from arbitrary places in our application—in particular, from the middle of a call to a function that does not yet exist.</p>
<p>The core idea is to replace a dynamically loaded function with a stub; this stub first of all loads the missing function code, replaces itself by the loaded code, and then calls the newly loaded code with the original arguments. Any subsequent call to the function goes directly to the loaded function. This strategy allows for an essentially transparent approach to dynamically loading code.</p>
<p>The module we are going to load is fairly simple, it contains a function that returns <code>42</code>:</p>
<pre class="language-c"><code class="language-c"><span class="token comment">// This is a simple provider of forty-two</span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;emscripten.h&gt;</span></span><br><br>EMSCRIPTEN_KEEPALIVE <span class="token keyword">long</span> <span class="token function">provide42</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token number">42l</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>which is in a file called <code>p42.c</code>, and is compiled using Emscripten without building any ‘extras’:</p>
<pre class="language-sh"><code class="language-sh">emcc p42.c <span class="token parameter variable">-o</span> p42.wasm --no-entry -Wl,--import-memory</code></pre>
<p>The <code>EMSCRIPTEN_KEEPALIVE</code> prefix is an Emscripten macro that makes sure that the function <code>provide42</code> is not eliminated even though it is not used within the code. This results in a WebAssembly module that contains the function that we want to load dynamically.</p>
<p>The <code>-Wl,--import-memory</code> flag that we added to the build of <code>p42.c</code> is to ensure that it has access to the same memory that the main module has.<sup class="footnote-ref"><a href="https://v8.dev/blog/jspi#fn6" id="fnref6" rel="noreferrer" target="_blank">[6]</a></sup></p>
<p>In order to dynamically load code, we use the standard <code>WebAssembly.instantiateStreaming</code> API:</p>
<pre class="language-js"><code class="language-js">WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'p42.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>This expression uses <code>fetch</code> to locate the compiled Wasm module, <code>WebAssembly.instantiateStreaming</code> to compile the result of the fetch and to create an instantiated module from it. Both <code>fetch</code> and <code>WebAssembly.instantiateStreaming</code> return Promises; so we cannot simply access the result and extract our needed function. Instead we wrap this into an JSPI-style import using the <code>EM_ASYNC_JS</code> macro:</p>
<pre class="language-c"><code class="language-c"><span class="token function">EM_ASYNC_JS</span><span class="token punctuation">(</span>fooFun<span class="token punctuation">,</span> resolveFun<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token char">'loading promise42'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  LoadedModule <span class="token operator">=</span> <span class="token punctuation">(</span>await WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token char">'p42.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>instance<span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token function">addFunction</span><span class="token punctuation">(</span>LoadedModule<span class="token punctuation">.</span>exports<span class="token punctuation">[</span><span class="token char">'provide42'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Notice the <code>console.log</code> call, we will use it to make sure that our logic is correct.</p>
<p>The <code>addFunction</code> is part of the Emscripten API, but to make sure that it is available for us at run-time, we have to inform <code>emcc</code> that it is a required dependency. We do that in the following line:</p>
<pre class="language-c"><code class="language-c"><span class="token function">EM_JS_DEPS</span><span class="token punctuation">(</span>funDeps<span class="token punctuation">,</span> <span class="token string">"$addFunction"</span><span class="token punctuation">)</span></code></pre>
<p>In a situation where we want to dynamically load code, we would like to make sure that we don’t load code unnecessarily; in this case, we would like to make sure that subsequent calls to <code>provide42</code> will not trigger reloads. C has a simple feature that we can use for this: we don’t call <code>provide42</code> directly, but do so via a trampoline that will cause the function to be loaded, and then, just before actually invoking the function, change the trampoline to bypass itself. We can do this using an appropriate function pointer:</p>
<pre class="language-c"><code class="language-c"><span class="token keyword">extern</span> fooFun get42<span class="token punctuation">;</span><br><br><span class="token keyword">long</span> <span class="token function">stub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>  get42 <span class="token operator">=</span> <span class="token function">resolveFun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token function">get42</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br>fooFun get42 <span class="token operator">=</span> stub<span class="token punctuation">;</span></code></pre>
<p>From the perspective of the rest of the program, the function that we want to call is called <code>get42</code>. Its initial implementation is via <code>stub</code>, which calls <code>resolveFun</code> to actually load the function. After the successful load, we change get42 to point to the newly loaded function – and call it.</p>
<p>Our main function calls <code>get42</code> twice:<sup class="footnote-ref"><a href="https://v8.dev/blog/jspi#fn7" id="fnref7" rel="noreferrer" target="_blank">[7]</a></sup></p>
<pre class="language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"first call p42() = %ld\n"</span><span class="token punctuation">,</span> <span class="token function">get42</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"second call = %ld\n"</span><span class="token punctuation">,</span> <span class="token function">get42</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>The result of running this in the browser is a log that looks like:</p>
<pre><code>loading promise42
first call p42() = 42
second call = 42
</code></pre>
<p>Notice that the line <code>loading promise42</code> only appears once, whereas <code>get42</code> is actually called twice.</p>
<p>This example demonstrates that JSPI can be used in some unexpected ways: loading code dynamically seems a long way from creating promises. Moreover, there are other ways of dynamically linking WebAssembly modules together; this is not intended to represent the definitive solution to that problem.</p>
<p>We are definitely looking forward to seeing what you can do with this new capability! Join the discussion at the W3C WebAssembly Community Group <a href="https://github.com/WebAssembly/js-promise-integration" rel="noreferrer" target="_blank">repo</a>.</p>
<h2 id="appendix-a%3A-complete-listing-of-badfib" tabindex="-1">Appendix A: Complete Listing of <code>badfib</code> <a class="bookmark" href="https://v8.dev/blog/jspi#appendix-a%3A-complete-listing-of-badfib" rel="noreferrer" target="_blank">#</a></h2>
<pre class="language-c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;emscripten.h&gt;</span></span><br><br><span class="token keyword">typedef</span> <span class="token keyword">long</span> <span class="token punctuation">(</span>testFun<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">microSeconds</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span></span></span><br><br><span class="token keyword">long</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">,</span> <span class="token keyword">long</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// Ask JS to do the addition</span><br><span class="token function">EM_JS</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">,</span> jsAdd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">,</span> <span class="token keyword">long</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// promise an addition</span><br><span class="token function">EM_ASYNC_JS</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">,</span> promiseAdd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">,</span> <span class="token keyword">long</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token operator">+</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>noinline<span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token keyword">long</span> <span class="token function">localFib</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span><br> <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><br>   <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><br> <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><br>   <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><br> <span class="token keyword">return</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token function">localFib</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">localFib</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>noinline<span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token keyword">long</span> <span class="token function">jsFib</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token function">jsAdd</span><span class="token punctuation">(</span><span class="token function">jsFib</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">jsFib</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>noinline<span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token keyword">long</span> <span class="token function">promiseFib</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token function">promiseAdd</span><span class="token punctuation">(</span><span class="token function">promiseFib</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">promiseFib</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">long</span> <span class="token function">runLocal</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">long</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> ix <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ix <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> ix<span class="token operator">++</span><span class="token punctuation">)</span><br>    temp <span class="token operator">+=</span> <span class="token function">localFib</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> temp <span class="token operator">/</span> count<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">long</span> <span class="token function">runJs</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">,</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">long</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> ix <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ix <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> ix<span class="token operator">++</span><span class="token punctuation">)</span><br>    temp <span class="token operator">+=</span> <span class="token function">jsFib</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> temp <span class="token operator">/</span> count<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">long</span> <span class="token function">runPromise</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">long</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br>  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> ix <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ix <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> ix<span class="token operator">++</span><span class="token punctuation">)</span><br>    temp <span class="token operator">+=</span> <span class="token function">promiseFib</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> temp <span class="token operator">/</span> count<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">double</span> <span class="token function">runTest</span><span class="token punctuation">(</span>testFun test<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">{</span><br>  <span class="token class-name">clock_t</span> start <span class="token operator">=</span> <span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">test</span><span class="token punctuation">(</span>limit<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token class-name">clock_t</span> stop <span class="token operator">=</span> <span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span>stop <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> CLOCKS_PER_SEC<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">void</span> <span class="token function">runTestSequence</span><span class="token punctuation">(</span><span class="token keyword">int</span> step<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ix <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ix <span class="token operator">&lt;=</span> limit<span class="token punctuation">;</span> ix <span class="token operator">+=</span> step<span class="token punctuation">)</span><span class="token punctuation">{</span><br>    <span class="token keyword">double</span> light <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">runTest</span><span class="token punctuation">(</span>runLocal<span class="token punctuation">,</span> ix<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token operator">/</span> count<span class="token punctuation">)</span> <span class="token operator">*</span> microSeconds<span class="token punctuation">;</span><br>    <span class="token keyword">double</span> jsTime <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">runTest</span><span class="token punctuation">(</span>runJs<span class="token punctuation">,</span> ix<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token operator">/</span> count<span class="token punctuation">)</span> <span class="token operator">*</span> microSeconds<span class="token punctuation">;</span><br>    <span class="token keyword">double</span> promiseTime <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">runTest</span><span class="token punctuation">(</span>runPromise<span class="token punctuation">,</span> ix<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token operator">/</span> count<span class="token punctuation">)</span> <span class="token operator">*</span> microSeconds<span class="token punctuation">;</span><br>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fib(%d) %gμs %gμs %gμs %gμs\n"</span><span class="token punctuation">,</span>ix<span class="token punctuation">,</span> light<span class="token punctuation">,</span> jsTime<span class="token punctuation">,</span> promiseTime<span class="token punctuation">,</span> <span class="token punctuation">(</span>promiseTime <span class="token operator">-</span> jsTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br>EMSCRIPTEN_KEEPALIVE <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">int</span> step <span class="token operator">=</span>  <span class="token number">1</span><span class="token punctuation">;</span><br>  <span class="token keyword">int</span> limit <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span><br>  <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span><br>  <span class="token function">runTestSequence</span><span class="token punctuation">(</span>step<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<h2 id="appendix-b%3A-listing-of-u42.c-and-p42.c" tabindex="-1">Appendix B: Listing of <code>u42.c</code> and <code>p42.c</code> <a class="bookmark" href="https://v8.dev/blog/jspi#appendix-b%3A-listing-of-u42.c-and-p42.c" rel="noreferrer" target="_blank">#</a></h2>
<p>The <code>u42.c</code> C code represents the main part of our dynamic loading example:</p>
<pre class="language-c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;emscripten.h&gt;</span></span><br><br><span class="token keyword">typedef</span> <span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>fooFun<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// promise a function</span><br><span class="token function">EM_ASYNC_JS</span><span class="token punctuation">(</span>fooFun<span class="token punctuation">,</span> resolveFun<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token char">'loading promise42'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  LoadedModule <span class="token operator">=</span> <span class="token punctuation">(</span>await WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token char">'p42.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>instance<span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token function">addFunction</span><span class="token punctuation">(</span>LoadedModule<span class="token punctuation">.</span>exports<span class="token punctuation">[</span><span class="token char">'provide42'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token function">EM_JS_DEPS</span><span class="token punctuation">(</span>funDeps<span class="token punctuation">,</span> <span class="token string">"$addFunction"</span><span class="token punctuation">)</span><br><br><span class="token keyword">extern</span> fooFun get42<span class="token punctuation">;</span><br><br><span class="token keyword">long</span> <span class="token function">stub</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  get42 <span class="token operator">=</span> <span class="token function">resolveFun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token function">get42</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br>fooFun get42 <span class="token operator">=</span> stub<span class="token punctuation">;</span><br><br><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"first call p42() = %ld\n"</span><span class="token punctuation">,</span> <span class="token function">get42</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"second call = %ld\n"</span><span class="token punctuation">,</span> <span class="token function">get42</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>The <code>p42.c</code> code is the dynamically loaded module.</p>
<pre class="language-c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;emscripten.h&gt;</span></span><br><br>EMSCRIPTEN_KEEPALIVE <span class="token keyword">long</span> <span class="token function">provide42</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token number">42l</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<!-- Footnotes themselves at the bottom. -->
<h2 id="notes" tabindex="-1">Notes <a class="bookmark" href="https://v8.dev/blog/jspi#notes" rel="noreferrer" target="_blank">#</a></h2>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>If a WebAssembly application is suspended more than once, subsequent suspensions will return to the browser's event loop and will not be directly visible to the web application. <a href="https://v8.dev/blog/jspi#fnref1" class="footnote-backref" rel="noreferrer" target="_blank">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p>For the technically curious, see <a href="https://github.com/WebAssembly/js-promise-integration/blob/main/proposals/js-promise-integration/Overview.md" rel="noreferrer" target="_blank">the WebAssembly proposal for JSPI</a> and <a href="https://docs.google.com/document/d/16Us-pyte2-9DECJDfGm5tnUpfngJJOc8jbj54HMqE9Y" rel="noreferrer" target="_blank">the V8 stack switching design portfolio</a>. <a href="https://v8.dev/blog/jspi#fnref2" class="footnote-backref" rel="noreferrer" target="_blank">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p>JSPI is also available in Firefox nightly: turn on "<code>javascript.options.wasm_js_promise_integration</code>" in the about:config panel — and restart. <a href="https://v8.dev/blog/jspi#fnref3" class="footnote-backref" rel="noreferrer" target="_blank">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p>Note: we include the complete program below, in Appendix A. <a href="https://v8.dev/blog/jspi#fnref4" class="footnote-backref" rel="noreferrer" target="_blank">↩︎</a></p>
</li>
<li id="fn5" class="footnote-item"><p>Note: you need a version of Emscripten that is ≥ 3.1.61. <a href="https://v8.dev/blog/jspi#fnref5" class="footnote-backref" rel="noreferrer" target="_blank">↩︎</a></p>
</li>
<li id="fn6" class="footnote-item"><p>We do not need this flag for our specific example, but you would likely need it for anything bigger. <a href="https://v8.dev/blog/jspi#fnref6" class="footnote-backref" rel="noreferrer" target="_blank">↩︎</a></p>
</li>
<li id="fn7" class="footnote-item"><p>The complete program is shown in Appendix B. <a href="https://v8.dev/blog/jspi#fnref7" class="footnote-backref" rel="noreferrer" target="_blank">↩︎</a></p>
</li>
</ol>
</section>
<p></p></div>
		<div class="content-meta">
			<time datetime=2024-07-01T00:00:00.000Z>1 July 2024</time>
			<a href="/urls/v8-dev-blog-atom">v8.dev/blog.atom</a>
			<div> <a href="/tags/javascript.html">javascript</a> |  <a style="font-weight: bold" href="/tags/source.html">source</a></div>
		</div>
	</main>
		<footer>
			<nav>
				<a href="/">Home</a>
				<a href="/tags">Tags</a>
				<a href="/urls">URLs</a>
				<a rel="noreferrer" target="_blank" href="https://github.com/thoughtsunificator/rss-feed-static-generator">Source code</a>
			</nav>
		</footer>
		<script src="/highlight.min.js"></script>
		<script>hljs.highlightAll();</script>
		</body>
</html>